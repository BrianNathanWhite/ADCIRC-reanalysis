---
title: "ADCIRC-EDA"
author: "Brian N. White"
date: "2022-05-11"
output: html_document
---

```{r, include = F}
knitr::opts_chunk$set(fig.align = 'center', warning = F, message = F, tidy=TRUE)
```

```{r, include = F}
# data wrangling & visualization
library(tidyverse)
library(reshape2)
library(GGally)
library(gridExtra)
# extreme value analysis
library(extRemes)
# working with spatial data
library(maps)
library(ggmap)
library(geosphere)
library(naniar) # for replacing value with NA 
```

```{r import and clean data, warning = F, message = F}
# load data
df_meta_region3 <- read.csv('data/df_meta_region3.csv')
ADC_POST_Detided_region3 <- read.csv('data/ADC_POST_Detided_region3.csv')
NOAA_OBS_Detided_region3 <- read.csv('data/NOAA_OBS_Detided_region3.csv')
```

```{r clean data}
source('./functions/clean_timeseries.R') # converts time to POSIX class, adds variables month & year, replace station ID with station name
source('./functions/clean_metadata.R') # remove white space from station names

df_meta_region3 <- clean_metadata(df_meta_region3) # remove white space from station names


ADC_POST_Detided_region3 <- clean_timeseries(timeseries = ADC_POST_Detided_region3, 
                                             metadata = df_meta_region3 
                                                            %>% filter(stationname != 'Lewisetta')
                                             ) %>%
                                select(1:13, 15:14, 16:30)

NOAA_OBS_Detided_region3 <- clean_timeseries(timeseries = NOAA_OBS_Detided_region3, metadata = df_meta_region3) %>%
                              select(-Lewisetta) %>% # exclude Lewisetta for consistency with ADCIRC data
                              select(c(1:3, 30:4)) # re-arrange stations to match order of columns in ADC_POST_Detided_region3

df_meta_region3 <- df_meta_region3 %>% 
                          filter(stationname != 'Lewisetta') # remove Lewisetta from meta data
```

*Interactive Map of Stations*

[kepler.gl](https://kepler.gl/demo/map?mapUrl=https://dl.dropboxusercontent.com/s/jdmoouleyema7z1/keplergl_s3tjnff.json)

```{r produce map of stations, warning = F}
states <- map_data("state")

east_coast <- states %>%
  filter(region %in% c('florida', 'georgia', 'south carolina', 'north carolina', 'virginia', 'district of columbia', 'pennsylvania', 'maryland', 'delaware', 'new jersey', 'connecticut', 'new york', 'rhode island', 'massachusetts', 'vermont', 'new hampshire', 'maine' ))

ggplot() + 
  geom_polygon(data = east_coast, aes(x = long, y = lat, group = group, fill = group), color = "white") +
  geom_point(data = df_meta_region3, aes(x = lon, y = lat), col = 'black', size = .8) +
  geom_text(data = df_meta_region3, aes(x = lon, y = lat, label = stationname), size = 2.5, col = 'red', check_overlap = T) +
  guides(fill = F) +
  theme_nothing()
```

```{r hourly sea-level EDA, cache = T, message = F, warning = F}
# time-series of detided sea-levels
p1 <- ADC_POST_Detided_region3 %>%
  filter('2014-01-01 0:00:00' <= TIME, TIME <= '2014-01-01 23:00:00') %>% # one day
  select(TIME, WrightsvilleBeach) %>%
  ggplot(aes(x = TIME, y = WrightsvilleBeach)) +
  geom_point(col = 'blue', size = 0.5) +
  labs(x = 'Hour', y = 'Sea-level (m)', title = 'ADCIRC Reconstruction of Detided Hourly Sea-Level at Wrightsville Beach')

p2 <- NOAA_OBS_Detided_region3 %>%
  filter('2014-01-01 0:00:00' <= TIME, TIME <= '2014-01-01 23:00:00') %>% # one day
  select(TIME, WrightsvilleBeach) %>%
  ggplot(aes(x = TIME, y = WrightsvilleBeach)) +
  geom_point(col = 'red', size = 0.5) +
  labs(x = 'Hour', y = 'Sea-level (m)', title = 'Observed (NOAA) Detided Hourly Sea-Level at Wrightsville Beach')

grid.arrange(p1, p2, ncol = 2)

p3 <- ADC_POST_Detided_region3 %>%
  filter('1979-01-01 0:00:00' <= TIME, TIME <= '1979-02-01 00:00:00') %>% # one month
  select(TIME, WrightsvilleBeach) %>%
  ggplot(aes(x = TIME, y = WrightsvilleBeach)) +
  geom_point(col = 'blue', size = 0.1) +
  labs(x = 'Month', y = 'Sea-level (m)', title = 'ADCIRC Reconstruction of Detided Hourly Sea-Level at Wrightsville Beach')

p4 <- NOAA_OBS_Detided_region3 %>%
  filter('2014-01-01 0:00:00' <= TIME, TIME <= '2014-02-01 00:00:00') %>% # one month
  select(TIME, WrightsvilleBeach) %>%
  ggplot(aes(x = TIME, y = WrightsvilleBeach)) +
  geom_point(col = 'red', size = 0.1) +
  labs(x = 'Month', y = 'Sea-level (m)', title = 'Observed (NOAA) Detided Hourly Sea-Level at Wrightsville Beach')

grid.arrange(p3, p4, ncol = 2)

p5 <- ADC_POST_Detided_region3 %>%
  filter('1979-01-01 0:00:00' <= TIME, TIME <= '1980-01-01 00:00:00') %>% # one year
  select(TIME, WrightsvilleBeach) %>%
  ggplot(aes(x = TIME, y = WrightsvilleBeach)) +
  geom_point(col = 'blue', size = 0.1) +
  labs(x = 'Year', y = 'Sea-level (m)', title = 'ADCIRC Reconstruction of Detided Hourly Sea-Level at Wrightsville Beach')

p6 <- NOAA_OBS_Detided_region3 %>%
  filter('2014-01-01 0:00:00' <= TIME, TIME <= '2015-01-01 00:00:00') %>% # one year
  select(TIME, WrightsvilleBeach) %>%
  ggplot(aes(x = TIME, y = WrightsvilleBeach)) +
  geom_point(col = 'red', size = 0.1) +
  labs(x = 'Year', y = 'Sea-level (m)', title = 'Observed (NOAA) Detided Hourly Sea-Level at Wrightsville Beach')

grid.arrange(p5, p6, ncol = 2)

p7 <- ADC_POST_Detided_region3 %>% # complete time-series
  select(TIME, WrightsvilleBeach) %>%
  ggplot(aes(x = TIME, y = WrightsvilleBeach)) +
  geom_point(col = 'blue', size = 0.1) +
  labs(x = 'Year', y = 'Sea-level (m)', title = 'ADCIRC Reconstruction of Detided Hourly Sea-Level at Wrightsville Beach')

p8 <- NOAA_OBS_Detided_region3 %>% # complete time-series
  select(TIME, WrightsvilleBeach) %>%
  ggplot(aes(x = TIME, y = WrightsvilleBeach)) +
  geom_point(col = 'red', size = 0.1) +
  labs(x = 'Year', y = 'Sea-level (m)', title = 'Observed (NOAA) Detided Hourly Sea-Level at Wrightsville Beach')

grid.arrange(p7, p8, ncol = 2)


# time-series for each station
ADC_POST_Detided_region3[, -c(2, 3, 4)] %>%
  melt(id.vars = c('TIME')) %>%
  ggplot(aes(x = TIME, y = value, color = 'blue', size = 0.01)) +
  geom_point() +
  facet_wrap(~variable) +
  labs(x = 'Sea-Level (m)', y = 'Station', title = 'Time-Series of ADCIRC Reconstruction of Detided Hourly Sea-Level at each Location')

# box plots each station
ADC_POST_Detided_region3 %>%
  select(-TIME, -year, -month) %>%
  melt() %>%
  ggplot(aes(x = value, y = variable)) +
  geom_boxplot(outlier.size = 0.1) +
  labs(x = 'Sea-Level (m)', y = 'Station', title = 'Boxplots for Detided ADCIRC Reconstructed Sea-Level at each Location')

NOAA_OBS_Detided_region3 %>%
  select(-TIME, -year, -month) %>%
  melt() %>%
  ggplot(aes(x = value, y = variable)) +
  geom_boxplot(outlier.size = 0.1) +
  labs(x = 'Sea-Level (m)', y = 'Station', title = 'Boxplots of NOAA Detided Sea-Level Record at each Location')
```

```{r daily mean sea-level creation}
# compute data frame with daily mean for each station (ADCIRC)
df_mean_ADCIRC <- ADC_POST_Detided_region3 %>%
  group_by(year, month, day) %>%
  summarise_all(mean, na.rm = T)

# compute data frame with daily mean for each station (ADCIRC)
df_mean_NOAA <- NOAA_OBS_Detided_region3 %>%
  group_by(year, month, day) %>%
  summarise_all(mean, na.rm = T)
```

```{r daily mean sea-level EDA, warning = F}
# compute data frame with daily mean for each station (ADCIRC)
df_mean_ADCIRC <- ADC_POST_Detided_region3 %>%
  group_by(year, month, day) %>%
  summarise_all(mean, na.rm = T)

# compute data frame with daily mean for each station (ADCIRC)
df_mean_NOAA <- NOAA_OBS_Detided_region3 %>%
  group_by(year, month, day) %>%
  summarise_all(mean, na.rm = T)

# examine time-series for detided daily mean sea-levels
df_mean_ADCIRC[, -c(1, 2, 3)] %>%
  as.tibble() %>%
  melt(id.vars = c('TIME')) %>%
  ggplot(aes(x = TIME, y = value)) +
  geom_point(col = 'light blue', size = 0.001) +
  facet_wrap(~variable) +
  labs(x = 'Year', y = 'Sea-level (m)', title = 'Time-Series for ADCIRC Reconstruction of Detided Daily Sea-Level Means')

df_mean_NOAA[, -c(1, 2, 3)] %>%
  as.tibble() %>%
  melt(id.vars = c('TIME')) %>%
  ggplot(aes(x = TIME, y = value)) +
  geom_point(col = 'light blue', size = 0.001) +
  facet_wrap(~variable) +
  labs(x = 'Year', y = 'Sea-level (m)', title = 'Time-Series for Observed (NOAA) Detided Daily Sea-Level Means')

# examine box plots for detided daily mean sea-level
df_mean_ADCIRC[, -c(1, 2, 3)] %>%
  as.tibble() %>%
  melt(id.vars = c('TIME')) %>%
  ggplot(aes(x = value, y = variable)) +
  geom_boxplot(outlier.size = 0.1) +
  labs(x = 'Sea-level (m)', y = 'Station', title = 'Boxplots for ADCIRC Reconstruction of Detided Daily Sea-Level Means')

df_mean_NOAA[, -c(1, 2, 3)] %>%
  as.tibble() %>%
  melt(id.vars = c('TIME')) %>%
  ggplot(aes(x = value, y = variable)) +
  geom_boxplot(outlier.size = 0.1) +
  labs(x = 'Sea-level (m)', y = 'Station', title = 'Boxplots for Observed (NOAA) Detided Daily Sea-Level Means')
```


```{r yearly maxima sea-level creation, message = F, warning = F}
# for examing missing valus in NOAA_OBS_Detided_region3
source('./functions/overview_na.R')
source('./functions/max_timeseries.R')

# less than or equal to 10% of data missing, logical specifies if by station of by year & station
# overview_na(NOAA_OBS_Detided_region3, 0.01, T) 

# use max_timeseries NA exclusion rule to compute yearly maxima
# test <- max_timeseries(df_mean_NOAA, 0.5)

# create data frame with yearly maxima over hourly observations for each station
# df_max <- ADC_POST_Detided_region3 %>%
#          select(-TIME, -month, -day) %>%
#         group_by(year) %>%
#        summarise_all(max, na.rm = T) %>%
#       mutate(year = as.numeric(year))

#df_max_NOAA <- NOAA_OBS_Detided_region3 %>%
#           select(-TIME, -month, -day) %>%
#           group_by(year) %>%
#           summarise_all(max, na.rm = T) %>%
#           mutate(year = as.numeric(year)) %>%
#           replace_with_na_all(~.x == -Inf)

# create data frame with yearly maxima over daily means for each station (ADCIRC)
df_max_ADCIRC <- df_mean_ADCIRC[, -(2:4)] %>%
              group_by(year) %>%
              summarise_all(max, na.rm = T) %>%
              mutate(year = as.numeric(year))
 
# create data frame with yearly maxima over daily means for each station (NOAA)
df_max_NOAA <- df_mean_NOAA[, -(2:4)] %>%
                  group_by(year) %>%
                  summarise_all(max, na.rm = T) %>%
                  mutate(year = as.numeric(year)) %>%
                  replace_with_na_all(~.x == -Inf)
```

```{r yearly maxima EDA, message = F, warning = F}
# single station (ADCIRC)
df_max_ADCIRC %>%
  select(year, FortPulaski) %>%
  ggplot(aes(x = year, y = FortPulaski)) +
  geom_point(col = 'blue') +
  labs(x = 'Year', y = 'Sea-level (m)', title = 'ADCIRC Reconstruction of Detided Sea-Level Maxima for Fort Pulaski')

# single station (NOAA)
df_max_NOAA %>%
  select(year, FortPulaski) %>%
  ggplot(aes(x = year, y = FortPulaski)) +
  geom_point(col = 'red') +
  labs(x = 'Year', y = 'Sea-level (m)', title = 'Observed (NOAA) Detided Sea-Level Maxima for Fort Pulaski')

# single station (NOAA & ACIRC)
df_max_NOAA %>%
  select(year, FortPulaski) %>%
  ggplot(aes(x = year, y = FortPulaski)) +
  geom_point(col = 'red') +
  geom_point(aes(x = year, y = FortPulaski), data = df_max, color = 'blue') + 
  labs(x = 'Year', y = 'Sea-level (m)')

# test$FortPulaski%>%
# ggplot(aes(x = year, y = max)) +
# geom_point(col = 'blue') +
# labs(x = 'Year', y = 'Sea-level (m)', title = 'NOAA Observed Detided Sea-Level Maxima for Wrightsville Beach') +
# scale_x_discrete(breaks = seq(1980, 2020, by = 10))

#  time-series for maxima
df_max_ADCIRC %>%
  as.tibble() %>%
  melt(id.vars = c('year')) %>%
  ggplot(aes(x = year, y = value)) +
  geom_point(col = 'blue', size = 0.01) +
  facet_wrap(~variable) +
  labs(x = 'Year', y = 'Sea-level (m)', title = 'Time-Series for ADCIRC Reconstruction of Detided Sea-Level Maxima') +
  scale_x_continuous(breaks = c(1980, 1995, 2010))

df_max_NOAA %>%
  as.tibble() %>%
  melt(id.vars = c('year')) %>%
  ggplot(aes(x = year, y = value)) +
  geom_point(col = 'blue', size = 0.01) +
  facet_wrap(~variable) +
  labs(x = 'Year', y = 'Sea-level (m)', title = 'Time-Series for Observed (NOAA) Detided Sea-Level Maxima') +
  scale_x_continuous(breaks = c(1980, 1995, 2010))
  
# box plots for maxima 
df_max_ADCIRC %>%
  select(-year) %>%
  melt() %>%
  ggplot(aes(x = value, y = variable)) +
  geom_boxplot(outlier.size = 0.01) +
  labs(y = 'Station', x = 'sea-level (m)', title = 'Boxplots for ADCIRC Reconstruction of Detided Sea-Level Maxima')

df_max_NOAA %>%
  select(-year) %>%
  melt() %>%
  ggplot(aes(x = value, y = variable)) +
  geom_boxplot(outlier.size = 0.01) +
  labs(y = 'Station', x = 'sea-level (m)', title = 'Boxplots for Observed (NOAA) Detided Sea-Level Maxima')

# density plots for maxima 
df_max_ADCIRC %>%
  as.tibble() %>%
  melt(id.vars = c('year')) %>%
  ggplot(aes(x = value)) +
  geom_density(col = 'blue') +
  facet_wrap(~variable) +
  labs(x = 'Sea-level (m)', title = 'Kernal Density Estimates for ADCIRC Reconstruction of Detided Sea-Level Maxima')

df_max_NOAA %>%
  as.tibble() %>%
  melt(id.vars = c('year')) %>%
  ggplot(aes(x = value)) +
  geom_density(col = 'blue') +
  facet_wrap(~variable) +
  labs(x = 'Sea-level (m)', title = 'Kernal Density Estimates for Observed (NOAA) Detided Sea-Level Maxima')
```
